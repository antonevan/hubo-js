// Generated by CoffeeScript 1.6.3
var applyTrajectory;

jQuery.event.props.push("dataTransfer");

$('body').on('dragover', function(event) {
  event.stopPropagation();
  event.preventDefault();
});

$('body').on('drop', function(event) {
  var file, files, reader;
  event.stopPropagation();
  event.preventDefault();
  files = event.dataTransfer.files;
  if (files.length > 1) {
    alert("You can only drop one file at a time.");
    return;
  }
  file = files[0];
  reader = new FileReader();
  reader.onload = function(e) {
    return loadTrajectoryString(e.target.result, applyTrajectory);
  };
  reader.readAsText(file);
});

$('#mouse_info_dialog').dialog({
  autoOpen: false,
  closeOnEscape: true,
  buttons: {
    OK: function() {
      return $(this).dialog('close');
    }
  }
});

$('#mouse_info_button').on('click', function() {
  return $('#mouse_info_dialog').dialog('open');
});

$('#paste_traj_dialog').dialog({
  autoOpen: false,
  closeOnEscape: true,
  closeText: 'hide',
  buttons: {
    Cancel: function() {
      return $(this).dialog('close');
    },
    Load: function() {
      loadTrajectoryString($('#traj_input').val(), applyTrajectory);
      $('#traj_input').val('');
      return $(this).dialog('close');
    }
  }
});

watch(playback, 'state', function() {
  var ui, _ref;
  console.log(this);
  ui = $('#toggle_play');
  if ((_ref = this.state) === 'NOT_LOADED' || _ref === 'LOADING') {
    ui.attr('disabled', 'disabled');
  } else {
    ui.removeAttr('disabled');
  }
  switch (this.state) {
    case 'PLAYING':
      return ui.html('Pause');
    case 'DONE_PLAYING':
      return ui.html('Replay');
    default:
      return ui.html('Play');
  }
});

applyTrajectory = function(headers, data) {
  var i, id, _i, _j, _len, _ref;
  console.log(data.length);
  playback.data = data;
  playback.framerate = 200;
  headers[headers.indexOf('LKN')] = 'LKP';
  headers[headers.indexOf('RKN')] = 'RKP';
  headers[headers.indexOf('LEB')] = 'LEP';
  headers[headers.indexOf('REB')] = 'REP';
  for (i = _i = 0, _ref = data.length - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
    data[i][headers.indexOf('LSR')] += 20 / 180 * Math.PI;
    data[i][headers.indexOf('RSR')] -= 20 / 180 * Math.PI;
  }
  playback.working_headers = {};
  for (_j = 0, _len = headers.length; _j < _len; _j++) {
    id = headers[_j];
    if (hubo.motors[id] != null) {
      playback.working_headers[id] = headers.indexOf(id);
    }
  }
  playback.state = 'LOADED';
  playback.frame = 0;
  togglePlay();
};

$('#traj_selection').on('change', function(event) {
  if ($(this).val() === '') {
    return;
  }
  if ($(this).val() === 'clipboard') {
    $('#paste_traj_dialog').dialog('open');
  }
  playback.state = 'LOADING';
  playback.filename = ("" + local_root + "data/hubo-trajectories/") + $(this).val();
  hubo.reset();
  c.render();
  return loadTrajectoryFile(playback.filename, applyTrajectory);
});

$('#toggle_play').on('click', togglePlay);

$('#load').on('click', function(event) {
  var callback, progress;
  $(this).html("Loading...").attr('disabled', 'disabled');
  window.c = new WebGLRobots.DefaultCanvas('#hubo_container');
  return window.hubo = new Hubo('hubo2', callback = function() {
    c.add(hubo);
    hubo.autorender = false;
    $('#panel_load').hide();
    return $('#panel_traj').show();
  }, progress = function(step, total, node) {
    return $('#load').html("Loading " + step + "/" + total);
  });
});

$(document).ready(function() {
  window.stats = new Stats();
  stats.setMode(0);
  $('#hubo_container').append(stats.domElement);
  stats.domElement.style.position = 'absolute';
  stats.domElement.style.left = '400px';
  return stats.domElement.style.top = '0px';
});
